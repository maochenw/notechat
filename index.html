<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NoteChat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100%;
    }

    /* ── Join Screen ── */
    #join-screen {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }
    #join-screen .join-inner {
      width: 100%;
      max-width: 420px;
      text-align: center;
    }
    #join-screen h1 {
      font-size: 2rem;
      margin-bottom: .25rem;
      color: #f8fafc;
    }
    #join-screen .subtitle {
      color: #94a3b8;
      margin-bottom: 1.5rem;
      font-size: .95rem;
    }
    .form-input {
      width: 100%;
      padding: .75rem 1rem;
      margin-bottom: .75rem;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #1e293b;
      color: #f8fafc;
      font-size: 1rem;
      outline: none;
      transition: border-color .2s;
    }
    .form-input:focus { border-color: #6366f1; }
    .btn-primary {
      width: 100%;
      padding: .75rem;
      border: none;
      border-radius: 8px;
      background: #6366f1;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }
    .btn-primary:hover { background: #4f46e5; }

    .divider {
      display: flex;
      align-items: center;
      gap: .75rem;
      margin: 1.5rem 0;
      color: #475569;
      font-size: .8rem;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #334155;
    }

    /* ── Schedule form ── */
    .schedule-form {
      display: flex;
      gap: .5rem;
      margin-bottom: .75rem;
      flex-wrap: wrap;
    }
    .schedule-form .form-input {
      flex: 1;
      min-width: 0;
      margin-bottom: 0;
    }
    .schedule-form .sched-room-input {
      flex: 0 0 90px;
    }
    .schedule-form input[type="datetime-local"] {
      color-scheme: dark;
      flex: 1 1 160px;
    }
    .btn-secondary {
      padding: .75rem 1rem;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #1e293b;
      color: #a5b4fc;
      font-size: .85rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: border-color .2s, color .2s;
    }
    .btn-secondary:hover { border-color: #6366f1; color: #f8fafc; }

    /* ── Scheduled rooms list ── */
    .scheduled-list {
      text-align: left;
      max-height: 260px;
      overflow-y: auto;
    }
    .scheduled-list .empty {
      text-align: center;
      color: #475569;
      font-size: .85rem;
      padding: .75rem 0;
    }
    .scheduled-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .6rem .85rem;
      margin-bottom: .4rem;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      cursor: pointer;
      transition: border-color .2s;
      gap: .5rem;
    }
    .scheduled-item:hover { border-color: #6366f1; }
    .scheduled-item .room-info {
      display: flex;
      align-items: baseline;
      gap: .5rem;
      min-width: 0;
      flex: 1;
    }
    .scheduled-item .room-num {
      font-weight: 700;
      font-size: 1rem;
      color: #f8fafc;
      flex-shrink: 0;
    }
    .scheduled-item .room-time {
      font-size: .85rem;
      color: #a5b4fc;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .scheduled-item .remove-sched {
      background: none;
      border: none;
      color: #64748b;
      font-size: 1.2rem;
      cursor: pointer;
      padding: .1rem .4rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .scheduled-item .remove-sched:hover { color: #ef4444; }

    /* ── Sticker upload section (landing page) ── */
    .sticker-upload-section input[type="file"] { display: none; }
    .sticker-grid {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      justify-content: center;
      margin-top: .75rem;
    }
    .sticker-grid .empty {
      color: #475569;
      font-size: .85rem;
      padding: .75rem 0;
      width: 100%;
      text-align: center;
    }
    .sticker-thumb {
      position: relative;
      width: 64px;
      height: 64px;
    }
    .sticker-thumb img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #334155;
    }
    .sticker-thumb .remove-sticker {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: #ef4444;
      color: #fff;
      font-size: .7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .sticker-thumb .remove-sticker:hover { background: #dc2626; }

    /* hidden canvas for cropping */
    #crop-canvas { display: none; }

    /* ── Chat Screen ── */
    #chat-screen {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: .75rem 1rem;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      flex-shrink: 0;
    }
    .chat-header .room-label {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .chat-header .user-count {
      font-size: .85rem;
      color: #94a3b8;
    }
    .chat-header button {
      background: none;
      border: 1px solid #475569;
      color: #94a3b8;
      padding: .4rem .75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: .85rem;
    }
    .chat-header button:hover { color: #f8fafc; border-color: #94a3b8; }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      -webkit-overflow-scrolling: touch;
    }

    .msg {
      max-width: 80%;
      padding: .6rem .9rem;
      border-radius: 12px;
      line-height: 1.45;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .msg.system {
      align-self: center;
      max-width: 100%;
      background: none;
      color: #64748b;
      font-size: .8rem;
      text-align: center;
      padding: .25rem 0;
    }
    .msg.self {
      align-self: flex-end;
      background: #6366f1;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.other {
      align-self: flex-start;
      background: #1e293b;
      border-bottom-left-radius: 4px;
    }
    .msg.sticker-msg {
      background: none !important;
      padding: .2rem;
    }
    .msg .author {
      font-size: .75rem;
      font-weight: 600;
      color: #a5b4fc;
      margin-bottom: 2px;
    }
    .msg.self .author { color: rgba(255,255,255,.7); }
    .msg.sticker-msg.self .author { color: #a5b4fc; }
    .msg .time {
      font-size: .65rem;
      color: rgba(255,255,255,.45);
      margin-top: 2px;
      text-align: right;
    }
    .msg.other .time { color: #64748b; }
    .msg.sticker-msg .time { color: #64748b; }

    .msg .sticker-img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .msg img:not(.sticker-img) {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 4px;
      cursor: pointer;
    }
    .msg video {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 4px;
    }

    /* ── Sticker picker panel (chat) ── */
    .sticker-picker {
      display: none;
      padding: .75rem;
      background: #1e293b;
      border-top: 1px solid #334155;
      flex-shrink: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .sticker-picker.active { display: block; }
    .sticker-picker .sticker-picker-grid {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .sticker-picker .sticker-picker-grid .empty {
      color: #475569;
      font-size: .85rem;
      padding: .25rem 0;
    }
    .sticker-picker .sticker-pick {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color .15s, transform .15s;
    }
    .sticker-picker .sticker-pick:hover {
      border-color: #6366f1;
      transform: scale(1.1);
    }

    .chat-input {
      display: flex;
      padding: .6rem .75rem;
      gap: .4rem;
      background: #1e293b;
      border-top: 1px solid #334155;
      align-items: flex-end;
      flex-shrink: 0;
    }
    .chat-input input[type="text"] {
      flex: 1;
      padding: .7rem .75rem;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #0f172a;
      color: #f8fafc;
      font-size: 1rem;
      outline: none;
      min-width: 0;
    }
    .chat-input input[type="text"]:focus { border-color: #6366f1; }
    .chat-input input[type="file"] { display: none; }

    .chat-input .icon-btn {
      padding: .6rem;
      border: 1px solid #334155;
      border-radius: 8px;
      background: #0f172a;
      color: #94a3b8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 42px;
      flex-shrink: 0;
    }
    .chat-input .icon-btn:hover { border-color: #6366f1; color: #f8fafc; }
    .chat-input .icon-btn.active { border-color: #6366f1; color: #a5b4fc; }

    .chat-input .send-btn {
      padding: .7rem 1rem;
      border: none;
      border-radius: 8px;
      background: #6366f1;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      flex-shrink: 0;
    }
    .chat-input .send-btn:hover { background: #4f46e5; }

    /* File preview bar */
    .file-preview {
      display: none;
      padding: .5rem 1rem;
      background: #1e293b;
      border-top: 1px solid #334155;
      align-items: center;
      gap: .75rem;
      flex-shrink: 0;
    }
    .file-preview.active { display: flex; }
    .file-preview img,
    .file-preview video {
      max-height: 60px;
      border-radius: 6px;
    }
    .file-preview .file-name {
      flex: 1;
      font-size: .85rem;
      color: #94a3b8;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .file-preview .remove-btn {
      background: none;
      border: none;
      color: #ef4444;
      font-size: 1.1rem;
      cursor: pointer;
      padding: .25rem;
    }

    /* Lightbox overlay */
    .lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .lightbox.active { display: flex; }
    .lightbox img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
    }

    /* ── Mobile ── */
    @media (max-width: 480px) {
      #join-screen {
        justify-content: flex-start;
        padding: 1.5rem 1rem;
      }
      #join-screen h1 { font-size: 1.6rem; }
      .schedule-form {
        flex-direction: column;
      }
      .schedule-form .sched-room-input {
        flex: unset;
        width: 100%;
      }
      .msg { max-width: 88%; }
    }
  </style>
</head>
<body>

  <!-- Join Screen -->
  <div id="join-screen">
    <div class="join-inner">
      <h1>NoteChat</h1>
      <p class="subtitle">Enter a room number to join or create a chat room.</p>
      <input id="name-input" class="form-input" type="text" placeholder="Your name" maxlength="30" autofocus>
      <input id="room-input" class="form-input" type="text" placeholder="Room number" maxlength="20">
      <button class="btn-primary" id="join-btn">Join Room</button>

      <div class="divider">or publish a scheduled room</div>

      <div class="schedule-form">
        <input id="sched-room" class="form-input sched-room-input" type="text" placeholder="Room #" maxlength="20">
        <input id="sched-time" class="form-input" type="datetime-local">
        <button class="btn-secondary" id="publish-btn">Publish</button>
      </div>

      <div class="scheduled-list" id="scheduled-list">
        <div class="empty">No scheduled rooms yet</div>
      </div>

      <div class="divider">custom stickers</div>

      <div class="sticker-upload-section">
        <button class="btn-secondary" id="add-sticker-btn" style="width:100%">Upload Sticker Image</button>
        <input type="file" id="sticker-file-input" accept="image/*">
        <canvas id="crop-canvas" width="128" height="128"></canvas>
        <div class="sticker-grid" id="sticker-grid-landing">
          <div class="empty">No stickers yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div class="chat-header">
      <div>
        <span class="room-label" id="room-label"></span>
        <span class="user-count" id="user-count"></span>
      </div>
      <button id="leave-btn">Leave</button>
    </div>
    <div id="messages"></div>
    <div class="sticker-picker" id="sticker-picker">
      <div class="sticker-picker-grid" id="sticker-picker-grid"></div>
    </div>
    <div class="file-preview" id="file-preview">
      <div id="file-thumb"></div>
      <span class="file-name" id="file-name"></span>
      <button class="remove-btn" id="remove-file">&times;</button>
    </div>
    <div class="chat-input">
      <button class="icon-btn" id="attach-btn" title="Attach photo or video">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21 15 16 10 5 21"/>
        </svg>
      </button>
      <button class="icon-btn" id="sticker-btn" title="Stickers">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
          <line x1="9" y1="9" x2="9.01" y2="9"/>
          <line x1="15" y1="9" x2="15.01" y2="9"/>
        </svg>
      </button>
      <input type="file" id="file-input" accept="image/*,video/*">
      <input id="msg-input" type="text" placeholder="Type a message..." maxlength="2000">
      <button class="send-btn" id="send-btn">Send</button>
    </div>
  </div>

  <!-- Lightbox for full-size images -->
  <div class="lightbox" id="lightbox">
    <img id="lightbox-img" src="">
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const joinScreen   = document.getElementById("join-screen");
    const chatScreen   = document.getElementById("chat-screen");
    const nameInput    = document.getElementById("name-input");
    const roomInput    = document.getElementById("room-input");
    const joinBtn      = document.getElementById("join-btn");
    const leaveBtn     = document.getElementById("leave-btn");
    const roomLabel    = document.getElementById("room-label");
    const userCount    = document.getElementById("user-count");
    const messagesEl   = document.getElementById("messages");
    const msgInput     = document.getElementById("msg-input");
    const sendBtn      = document.getElementById("send-btn");
    const attachBtn    = document.getElementById("attach-btn");
    const fileInput    = document.getElementById("file-input");
    const filePreview  = document.getElementById("file-preview");
    const fileThumb    = document.getElementById("file-thumb");
    const fileName     = document.getElementById("file-name");
    const removeFile   = document.getElementById("remove-file");
    const lightbox     = document.getElementById("lightbox");
    const lightboxImg  = document.getElementById("lightbox-img");
    const schedRoom    = document.getElementById("sched-room");
    const schedTime    = document.getElementById("sched-time");
    const publishBtn   = document.getElementById("publish-btn");
    const scheduledList = document.getElementById("scheduled-list");
    const addStickerBtn = document.getElementById("add-sticker-btn");
    const stickerFileInput = document.getElementById("sticker-file-input");
    const cropCanvas   = document.getElementById("crop-canvas");
    const stickerGridLanding = document.getElementById("sticker-grid-landing");
    const stickerBtn   = document.getElementById("sticker-btn");
    const stickerPicker = document.getElementById("sticker-picker");
    const stickerPickerGrid = document.getElementById("sticker-picker-grid");

    let myName = "";
    let pendingFile = null;
    let currentStickers = [];

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function escapeHtml(str) {
      return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function renderMedia(msg) {
      if (!msg.fileUrl) return "";
      if (msg.mediaType === "video") {
        return `<video src="${msg.fileUrl}" controls playsinline></video>`;
      }
      return `<img src="${msg.fileUrl}" alt="shared image" onclick="openLightbox('${msg.fileUrl}')">`;
    }

    function openLightbox(src) {
      lightboxImg.src = src;
      lightbox.classList.add("active");
    }
    lightbox.addEventListener("click", () => {
      lightbox.classList.remove("active");
      lightboxImg.src = "";
    });

    function appendMessage(msg) {
      const div = document.createElement("div");
      div.classList.add("msg");

      if (msg.type === "system") {
        div.classList.add("system");
        div.textContent = msg.text;
      } else {
        const isSelf = msg.name === myName;
        div.classList.add(isSelf ? "self" : "other");

        if (msg.stickerUrl) {
          div.classList.add("sticker-msg");
          div.innerHTML =
            `<div class="author">${isSelf ? "You" : escapeHtml(msg.name)}</div>` +
            `<img class="sticker-img" src="${msg.stickerUrl}" alt="sticker">` +
            `<div class="time">${formatTime(msg.timestamp)}</div>`;
        } else {
          let content = `<div class="author">${isSelf ? "You" : escapeHtml(msg.name)}</div>`;
          if (msg.text) content += `<div>${escapeHtml(msg.text)}</div>`;
          content += renderMedia(msg);
          content += `<div class="time">${formatTime(msg.timestamp)}</div>`;
          div.innerHTML = content;
        }
      }

      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function joinRoom() {
      const name = nameInput.value.trim();
      const room = roomInput.value.trim();
      if (!name || !room) return;

      myName = name;
      roomLabel.textContent = `Room ${room}`;
      joinScreen.style.display = "none";
      chatScreen.style.display = "flex";
      messagesEl.innerHTML = "";

      socket.emit("join-room", { room, name });
      msgInput.focus();
    }

    joinBtn.addEventListener("click", joinRoom);
    roomInput.addEventListener("keydown", (e) => { if (e.key === "Enter") joinRoom(); });
    nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") roomInput.focus(); });

    leaveBtn.addEventListener("click", () => { location.reload(); });

    // ── File attachment ──
    attachBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;
      pendingFile = file;
      fileName.textContent = file.name;
      fileThumb.innerHTML = "";

      if (file.type.startsWith("video/")) {
        const vid = document.createElement("video");
        vid.src = URL.createObjectURL(file);
        vid.muted = true;
        fileThumb.appendChild(vid);
      } else {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        fileThumb.appendChild(img);
      }

      filePreview.classList.add("active");
    });

    removeFile.addEventListener("click", clearPendingFile);

    function clearPendingFile() {
      pendingFile = null;
      fileInput.value = "";
      filePreview.classList.remove("active");
      fileThumb.innerHTML = "";
      fileName.textContent = "";
    }

    // ── Send message ──
    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text && !pendingFile) return;

      let fileUrl = null;
      let mediaType = null;

      if (pendingFile) {
        const formData = new FormData();
        formData.append("file", pendingFile);

        try {
          const res = await fetch("/upload", { method: "POST", body: formData });
          if (!res.ok) throw new Error("Upload failed");
          const data = await res.json();
          fileUrl = data.url;
          mediaType = data.mediaType;
        } catch (err) {
          alert("Failed to upload file. Please try again.");
          return;
        }
        clearPendingFile();
      }

      socket.emit("send-message", { text, fileUrl, mediaType });
      msgInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

    socket.on("message", appendMessage);
    socket.on("chat-history", (history) => { history.forEach(appendMessage); });
    socket.on("user-count", (count) => { userCount.textContent = ` · ${count} online`; });

    // ── Scheduled rooms ──
    publishBtn.addEventListener("click", () => {
      const room = schedRoom.value.trim();
      const timeVal = schedTime.value;
      if (!room) { schedRoom.focus(); return; }
      if (!timeVal) { schedTime.focus(); return; }
      const formatted = new Date(timeVal).toLocaleString([], {
        month: "short", day: "numeric", hour: "numeric", minute: "2-digit"
      });
      socket.emit("publish-room", { room, time: formatted });
      schedRoom.value = "";
      schedTime.value = "";
    });

    function renderScheduledRooms(list) {
      if (!list.length) {
        scheduledList.innerHTML = '<div class="empty">No scheduled rooms yet</div>';
        return;
      }
      scheduledList.innerHTML = list.map((s) =>
        `<div class="scheduled-item" data-room="${escapeHtml(s.room)}" data-id="${escapeHtml(s.id)}">
          <div class="room-info">
            <span class="room-num">${escapeHtml(s.room)}</span>
            <span class="room-time">${escapeHtml(s.time)}</span>
          </div>
          <button class="remove-sched" title="Remove">&times;</button>
        </div>`
      ).join("");

      scheduledList.querySelectorAll(".scheduled-item").forEach((el) => {
        el.querySelector(".remove-sched").addEventListener("click", (e) => {
          e.stopPropagation();
          socket.emit("remove-scheduled", { id: el.dataset.id });
        });

        el.addEventListener("click", (e) => {
          if (e.target.closest(".remove-sched")) return;
          roomInput.value = el.dataset.room;
          roomInput.focus();
        });
      });
    }

    socket.on("scheduled-rooms", renderScheduledRooms);

    // ── Stickers ──
    addStickerBtn.addEventListener("click", () => stickerFileInput.click());

    stickerFileInput.addEventListener("change", () => {
      const file = stickerFileInput.files[0];
      if (!file) return;
      stickerFileInput.value = "";

      const img = new Image();
      img.onload = async () => {
        // Center-crop to square, resize to 128x128
        const size = Math.min(img.width, img.height);
        const sx = (img.width - size) / 2;
        const sy = (img.height - size) / 2;
        const ctx = cropCanvas.getContext("2d");
        ctx.clearRect(0, 0, 128, 128);
        ctx.drawImage(img, sx, sy, size, size, 0, 0, 128, 128);
        URL.revokeObjectURL(img.src);

        cropCanvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append("sticker", blob, "sticker.png");
          try {
            const res = await fetch("/upload-sticker", { method: "POST", body: formData });
            if (!res.ok) throw new Error("Upload failed");
          } catch (err) {
            alert("Failed to upload sticker.");
          }
        }, "image/png");
      };
      img.src = URL.createObjectURL(file);
    });

    function renderStickerGridLanding(list) {
      if (!list.length) {
        stickerGridLanding.innerHTML = '<div class="empty">No stickers yet</div>';
        return;
      }
      stickerGridLanding.innerHTML = list.map((s) =>
        `<div class="sticker-thumb" data-id="${s.id}">
          <img src="${s.url}" alt="sticker">
          <button class="remove-sticker" title="Remove">&times;</button>
        </div>`
      ).join("");

      stickerGridLanding.querySelectorAll(".remove-sticker").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const id = btn.closest(".sticker-thumb").dataset.id;
          socket.emit("remove-sticker", { id });
        });
      });
    }

    function renderStickerPickerChat(list) {
      if (!list.length) {
        stickerPickerGrid.innerHTML = '<span class="empty">No stickers — upload from the landing page</span>';
        return;
      }
      stickerPickerGrid.innerHTML = list.map((s) =>
        `<img class="sticker-pick" src="${s.url}" data-url="${s.url}" alt="sticker">`
      ).join("");

      stickerPickerGrid.querySelectorAll(".sticker-pick").forEach((img) => {
        img.addEventListener("click", () => {
          socket.emit("send-message", { text: "", stickerUrl: img.dataset.url });
          stickerPicker.classList.remove("active");
          stickerBtn.classList.remove("active");
        });
      });
    }

    socket.on("stickers", (list) => {
      currentStickers = list;
      renderStickerGridLanding(list);
      renderStickerPickerChat(list);
    });

    // Toggle sticker picker in chat
    stickerBtn.addEventListener("click", () => {
      const isOpen = stickerPicker.classList.toggle("active");
      stickerBtn.classList.toggle("active", isOpen);
    });
  </script>
</body>
</html>
